name: Deploy to VPS

on:
  push:
    branches: [ main ]

env:
  JAR_FILE_NAME: "my-app.jar"
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_PORT: ${{ secrets.SERVER_PORT }}
  SERVER_USER: ${{ secrets.SERVER_USER }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v2
      - name: Set up Java 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          java-home: /usr/lib/jvm/adoptopenjdk-17-hotspot-amd64
      - name: Build Jar File
        run: mvn -B package --file pom.xml
      - name: Add Host to known_hosts
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SERVER_KEY }}
          name: id_rsa
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: fail
      - name: Copy jar file to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_HOST }}
          username: ${{ env.SERVER_USER }}
          key: ${{ secrets.SECRET_KEY }}
          port: ${{ env.SERVER_PORT }}
          source: "target/${{ env.JAR_FILE_NAME }}"
          target: "/root/gymproject"
      - name: Kill Running Docker Container
        run: |
          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} '
            docker stop $(docker ps -q --filter name=my-app) || true
          '
      - name: Run Docker Compose
        run: ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_HOST }} 'cd /root/gymproject && docker-compose up -d'
